{"version":3,"file":"index.js","sources":["../src/lib/load-formbricks.ts","../src/index.ts"],"sourcesContent":["/*\n  eslint-disable no-console --\n  * Required for logging errors\n*/\nimport { type Result } from \"@formbricks/types/error-handlers\";\n\nlet isInitializing = false;\nlet isInitialized = false;\n\n// Load the SDK, return the result\nconst loadFormbricksSDK = async (apiHostParam: string): Promise<Result<void>> => {\n  if (!window.formbricks) {\n    const scriptTag = document.createElement(\"script\");\n    scriptTag.type = \"text/javascript\";\n    scriptTag.src = `${apiHostParam}/js/formbricks.umd.cjs`;\n    scriptTag.async = true;\n\n    const getFormbricks = async (): Promise<void> =>\n      new Promise<void>((resolve, reject) => {\n        const timeoutId = setTimeout(() => {\n          reject(new Error(`Formbricks SDK loading timed out`));\n        }, 10000);\n        scriptTag.onload = () => {\n          clearTimeout(timeoutId);\n          resolve();\n        };\n        scriptTag.onerror = () => {\n          clearTimeout(timeoutId);\n          reject(new Error(`Failed to load Formbricks SDK`));\n        };\n      });\n\n    document.head.appendChild(scriptTag);\n\n    try {\n      await getFormbricks();\n      return { ok: true, data: undefined };\n    } catch (error) {\n      const err = error as { message?: string };\n\n      return {\n        ok: false,\n        error: new Error(err.message ?? `Failed to load Formbricks SDK`),\n      };\n    }\n  }\n\n  return { ok: true, data: undefined };\n};\n\nconst functionsToProcess: { prop: string; args: unknown[] }[] = [];\n\nexport const loadFormbricksToProxy = async (prop: string, ...args: unknown[]): Promise<void> => {\n  // all of this should happen when not initialized:\n  if (!isInitialized) {\n    if (prop === \"init\") {\n      if (isInitializing) {\n        console.warn(\"ðŸ§± Formbricks - Warning: Formbricks is already initializing.\");\n        return;\n      }\n\n      // reset the initialization state\n      isInitializing = true;\n\n      const apiHost = (args[0] as { apiHost: string }).apiHost;\n      const loadSDKResult = await loadFormbricksSDK(apiHost);\n\n      if (loadSDKResult.ok) {\n        if (window.formbricks) {\n          // @ts-expect-error -- Required for dynamic function calls\n          void window.formbricks.init(...args);\n\n          isInitializing = false;\n          isInitialized = true;\n\n          // process the queued functions\n          for (const { prop: functionProp, args: functionArgs } of functionsToProcess) {\n            type FormbricksProp = keyof typeof window.formbricks;\n\n            if (typeof window.formbricks[functionProp as FormbricksProp] !== \"function\") {\n              console.error(`ðŸ§± Formbricks - Error: Method ${functionProp} does not exist on formbricks`);\n              continue;\n            }\n\n            // @ts-expect-error -- Required for dynamic function calls\n            (window.formbricks[functionProp] as unknown)(...functionArgs);\n          }\n        }\n      }\n    } else {\n      console.warn(\n        \"ðŸ§± Formbricks - Warning: Formbricks not initialized. This method will be queued and executed after initialization.\"\n      );\n\n      functionsToProcess.push({ prop, args });\n    }\n  } else if (window.formbricks) {\n    type Formbricks = typeof window.formbricks;\n    type FunctionProp = keyof Formbricks;\n    const functionPropTyped = prop as FunctionProp;\n\n    // @ts-expect-error -- Required for dynamic function calls\n    await window.formbricks[functionPropTyped](...args);\n  }\n};\n","import type Formbricks from \"@formbricks/js-core\";\nimport { loadFormbricksToProxy } from \"./lib/load-formbricks\";\n\ntype TFormbricks = typeof Formbricks;\ndeclare global {\n  interface Window {\n    formbricks: TFormbricks | undefined;\n  }\n}\n\nconst formbricksProxyHandler: ProxyHandler<TFormbricks> = {\n  get(_target, prop, _receiver) {\n    return (...args: unknown[]) => loadFormbricksToProxy(prop as string, ...args);\n  },\n};\n\nconst formbricks: TFormbricks = new Proxy({} as TFormbricks, formbricksProxyHandler);\n\n// eslint-disable-next-line import/no-default-export -- Required for UMD\nexport default formbricks;\n"],"names":[],"mappings":"AAMA,IAAI,iBAAiB;AACrB,IAAI,gBAAgB;AAGpB,MAAM,oBAAoB,OAAO,iBAAgD;AAC3E,MAAA,CAAC,OAAO,YAAY;AAChB,UAAA,YAAY,SAAS,cAAc,QAAQ;AACjD,cAAU,OAAO;AACP,cAAA,MAAM,GAAG,YAAY;AAC/B,cAAU,QAAQ;AAElB,UAAM,gBAAgB,YACpB,IAAI,QAAc,CAAC,SAAS,WAAW;AAC/B,YAAA,YAAY,WAAW,MAAM;AAC1B,eAAA,IAAI,MAAM,kCAAkC,CAAC;AAAA,SACnD,GAAK;AACR,gBAAU,SAAS,MAAM;AACvB,qBAAa,SAAS;AACd,gBAAA;AAAA,MACV;AACA,gBAAU,UAAU,MAAM;AACxB,qBAAa,SAAS;AACf,eAAA,IAAI,MAAM,+BAA+B,CAAC;AAAA,MACnD;AAAA,IAAA,CACD;AAEM,aAAA,KAAK,YAAY,SAAS;AAE/B,QAAA;AACF,YAAM,cAAc;AACpB,aAAO,EAAE,IAAI,MAAM,MAAM,OAAU;AAAA,aAC5B,OAAO;AACd,YAAM,MAAM;AAEL,aAAA;AAAA,QACL,IAAI;AAAA,QACJ,OAAO,IAAI,MAAM,IAAI,WAAW,+BAA+B;AAAA,MACjE;AAAA,IAAA;AAAA,EACF;AAGF,SAAO,EAAE,IAAI,MAAM,MAAM,OAAU;AACrC;AAEA,MAAM,qBAA0D,CAAC;AAEpD,MAAA,wBAAwB,OAAO,SAAiB,SAAmC;AAE9F,MAAI,CAAC,eAAe;AAClB,QAAI,SAAS,QAAQ;AACnB,UAAI,gBAAgB;AAClB,gBAAQ,KAAK,8DAA8D;AAC3E;AAAA,MAAA;AAIe,uBAAA;AAEX,YAAA,UAAW,KAAK,CAAC,EAA0B;AAC3C,YAAA,gBAAgB,MAAM,kBAAkB,OAAO;AAErD,UAAI,cAAc,IAAI;AACpB,YAAI,OAAO,YAAY;AAErB,eAAK,OAAO,WAAW,KAAK,GAAG,IAAI;AAElB,2BAAA;AACD,0BAAA;AAGhB,qBAAW,EAAE,MAAM,cAAc,MAAM,kBAAkB,oBAAoB;AAG3E,gBAAI,OAAO,OAAO,WAAW,YAA8B,MAAM,YAAY;AACnE,sBAAA,MAAM,iCAAiC,YAAY,+BAA+B;AAC1F;AAAA,YAAA;AAID,mBAAO,WAAW,YAAY,EAAc,GAAG,YAAY;AAAA,UAAA;AAAA,QAC9D;AAAA,MACF;AAAA,IACF,OACK;AACG,cAAA;AAAA,QACN;AAAA,MACF;AAEA,yBAAmB,KAAK,EAAE,MAAM,KAAA,CAAM;AAAA,IAAA;AAAA,EACxC,WACS,OAAO,YAAY;AAG5B,UAAM,oBAAoB;AAG1B,UAAM,OAAO,WAAW,iBAAiB,EAAE,GAAG,IAAI;AAAA,EAAA;AAEtD;AC9FA,MAAM,yBAAoD;AAAA,EACxD,IAAI,SAAS,MAAM,WAAW;AAC5B,WAAO,IAAI,SAAoB,sBAAsB,MAAgB,GAAG,IAAI;AAAA,EAAA;AAEhF;AAEA,MAAM,aAA0B,IAAI,MAAM,CAAA,GAAmB,sBAAsB;"}